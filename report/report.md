# 数字图像处理-课程大作业-人脸美颜

> 姓名：陈彦旭
>
> 班级：无24

## 整体流程

### 相机畸变矫正

模块 `calibrate.py` ：

`detect_corners()` 函数，加载棋盘格图片，检测和细化图像中角点，返回各个图像中角点在真实世界坐标系中的位置，和在图像坐标系中的位置。

`calibrate_camera()` 函数，使用 `detect_corners()` 函数返回的角点位置，计算相机内参矩阵和畸变系数.

`undistort_image()` 函数，接受一张存在畸变的图像，根据前面计算出的内参矩阵和畸变系数，返回去畸变的图像。

可见，使用标定相机后得到的内参矩阵和畸变系数，对自拍图像进行去畸变，图像边缘处出现了类似于枕型失真的现象，说明手机镜头直接拍摄的照片存在桶形失真。`cv2.getOptimalNewCameraMatrix()` 函数中 `alpha` 参数可以控制去畸变后图像中“黑边”与原始图像保留的比例，如果设置为1，则保留所有原始图像的像素，可能会出现黑边；如果设置为0，则只保留那些在所有重映射中都有有效像素的位置——裁掉尽可能多的黑边。为了不影响图像亮度分布和后续直方图均衡化等全图处理，我们应该尽量避免黑色区域，因此设置 `alpha=0` 。

### 图像预处理

模块 `preprocess.py` ：

色彩空间转换：

1. `rgb_to_hsi()` 函数，将 RGB 图像转换为 HSI 图像。
2. `hsi_to_rgb()` 函数，将 HSI 图像转换为 RGB 图像。

3种空域滤波器：

1. 中值滤波器 `median_filter()` 函数。
2. 高斯滤波器 `gaussian_filter()` 函数。
3. 双边滤波器 `bilateral_filter()` 函数。

2种直方图均衡化：

1. `histogram_equalization()` 函数，全局均衡化。
2. `clahe_equalization()` 函数，局部自适应均衡化。

2种图像高频提升：

1. `laplacian_sharpen()` 函数，拉普拉斯锐化。
2. `unsharp_mask()` 函数，反锐化掩模。

### 人脸检测与分割

模块 `detect_face.py` ：

3种阈值分割，分割出人脸区域，得到二值化图像：

1. `global_threshold()` 函数，全局阈值分割。
2. `otsu_threshold()` 函数，大津算法阈值分割。
3. `adaptive_threshold()` 函数，自适应阈值分割。

2两种边缘检测：

1. `soble_edge()` 函数，Soble 算子边缘检测。
2. `canny_edge()` 函数，Canny 算子边缘检测。

`morphological` 函数，对二值掩膜进行形态学操作，支持腐蚀、膨胀、开运算、闭运算、顶帽、黑帽等操作。

### 人脸美艳

`beautigy.py` 模块：

`whiten_face()` 美白函数，将图片转换到 LAB 空间，仅对 L 通道进行 CLAHE 均衡化，再与面部掩膜融合，最后转换回 RGB。

`smooth_skin()` 磨皮函数，对图像进行双边滤波处理，再与面部掩膜融合。

`squeeze_face()` 瘦脸函数，对面部区域做仿射水平压缩（在 X 方向上缩放因子 < 1），再与原图融合。

瘦脸函数中，是对全图进行操作，面部掩膜的作用仅仅是确定放缩变换的关系。我们对图像进行水平方向的放缩，只改变脸的胖瘦，不改变脸的高度。面部掩膜中人脸区域横坐标最小值与最大值分别为 $x_\min, x_\max$ ，面部中心的横坐标估计为两者的平均值 $x_{\text{center}}=(x_\min+x_\max)/2$ 。

如果设置瘦脸的比例为 $g < 1.0$ ，那么在原图像中，面部区域所在的竖状条带，即横坐标范围为 $[x_\min, x_\max]$ 的区域，宽度为 $W_{\text{face}} = x_\max - x_\min$ ，以竖轴 $x = x_{\text{center}}$ 为中心，向里压缩。

左边界横坐标由 $x_\min$ 映射至 $x_L=x_{\text{center}}-W_{\text{face}}/2*g$ 。

右边界横坐标由 $x_\max$ 映射至 $x_R=x_{\text{center}}+W_{\text{face}}/2*g$ 。

坐标映射关系为 $x'=x_{\text{center}}+(x-x_{\text{center}})*g$ 。压缩后人脸区域横坐标范围变为 $[x_L,x_R]$ 。

原图像中左半背景区域，横坐标范围为 $[0,x_\min-1]$ ，向右扩张至 $[0,x_L-1]$ ，坐标映射关系为 $\dfrac{x'}{x}=\dfrac{x_L-1}{x_\min-1}$ 。

右半背景区域，横坐标为 $[x_\max+1,W-1]$ ，向左扩张至 $[x_R+1,W-1]$ ，坐标映射关系为 $\dfrac{(W-1)-x'}{(W-1)-x}=\dfrac{(W-1)-(x_R+1)}{(W-1)-(x_\max+1)}$ 。

上述变换过程使用过双线性插值保持平滑，最后使用高斯滤波进一步平滑。

`enlarge_eye()` 大眼函数，在面部上半区域。用 Canny 边缘检测和形态学操作找到两个眼睛亮区的连通域，得到眼睛中心的坐标和眼睛的大小，使用局部的径向放缩函数，再使用掩膜融合到原图。

### 图像后处理

`blend.py` 模块：在之前对人脸区域的操作过程中，可能会对图片背景部分造成影响，因此对美颜后图片和原始图像进行融合，且使用渐变融合，使得拼接区域过渡自然。

`feather_mask()` 函数，对人脸区域的二值化掩膜进行高斯模糊，生成羽化掩膜。

`blend_image()` 函数，使用羽化掩膜对美颜后的图像和原始图像进行融合，保证边缘过渡自然。
